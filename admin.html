<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è²å¯ç±³åŠª | å¾Œå°ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&family=Plus+Jakarta+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #FFF8F0; font-family: 'Noto Serif TC', serif; }
        .glass-card { background: rgba(255, 255, 255, 0.9); border: 1px solid white; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-[#5D5046]">

    <!-- âœ… 1. æ–°å¢ Toast å®¹å™¨ -->
    <div id="toast-container" class="fixed top-5 right-1/2 translate-x-1/2 z-[100] space-y-2 w-full max-w-xs sm:max-w-md px-4"></div>

    <!-- ç™»å…¥ç•«é¢ (å…¨æ–°è¨­è¨ˆ) -->
    <div id="login-view" class="min-h-screen flex items-center justify-center p-4 bg-[#F7F2EC]">
        <div class="bg-white p-8 rounded-3xl w-full max-w-sm text-center space-y-8 shadow-xl shadow-[#D4B5A0]/10 border border-white">
            
            <div class="mx-auto w-24 h-24 rounded-full bg-white p-1.5 shadow-md border-2 border-[#FFF8F0] -mt-20">
                <img src="logo.jpg" alt="Logo" class="w-full h-full object-cover rounded-full">
            </div>

            <div class="space-y-2">
                <h1 class="text-3xl font-black text-[#5D5046]">è²å¯ç±³åŠª | ç®¡ç†å¾Œå°</h1>
                <p class="text-sm text-gray-400">è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ä»¥å­˜å–è³‡æ–™</p>
            </div>

            <div class="relative">
                <i data-lucide="lock" class="w-5 h-5 absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input type="password" id="password" placeholder="è¼¸å…¥å¯†ç¢¼" class="w-full p-4 pl-12 rounded-xl border bg-[#FAF5F0] focus:ring-2 focus:ring-[#D4B5A0] outline-none text-base transition-all">
            </div>

            <button onclick="handleLogin()" class="w-full py-4 bg-[#5D5046] text-white font-bold rounded-xl hover:bg-[#4a4038] transition-all active:scale-95 flex items-center justify-center gap-2 text-base">
                ç™»å…¥ç³»çµ± <i data-lucide="arrow-right" class="w-5 h-5"></i>
            </button>

            <div class="pt-4 border-t border-gray-100">
                <a href="index.html" class="text-sm text-gray-400 hover:text-[#5D5046] transition-colors inline-flex items-center gap-1.5">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                    è¿”å›å¡«å¯«é¦–é 
                </a>
            </div>
        </div>
    </div>

    <!-- ä¸»æ§å°ç•«é¢ -->
    <div id="dashboard-view" class="hidden min-h-screen pb-20">
        <nav class="bg-white/80 backdrop-blur-md p-4 sticky top-0 z-40 border-b border-[#D4B5A0]/20 flex justify-between items-center">
            <span class="font-black text-lg">BACKME ADMIN</span>
            <button onclick="handleLogout()" class="text-sm text-red-500 font-bold hover:bg-red-50 px-3 py-1 rounded-lg transition">ç™»å‡º</button>
        </nav>
        <div class="max-w-6xl mx-auto p-4 md:p-8 space-y-6">
            <div class="flex gap-4 sticky top-20 z-30 bg-[#FFF8F0]/90 p-2 -mx-2 backdrop-blur-sm rounded-2xl">
                <button onclick="switchTab('sales')" id="tab-sales" class="flex-1 py-3 bg-white rounded-xl font-bold shadow-sm ring-2 ring-[#6D7DBF] text-[#6D7DBF]">å¯µç‰©è²·è³£</button>
                <button onclick="switchTab('grooming')" id="tab-grooming" class="flex-1 py-3 bg-white/50 rounded-xl font-bold text-gray-400 hover:bg-white">ç¾å®¹æœå‹™</button>
            </div>

                        <!-- åˆ†é åˆ‡æ› -->
            <div class="flex gap-4 sticky top-20 z-30 bg-[#FFF8F0]/90 p-2 -mx-2 backdrop-blur-sm rounded-2xl">
                <!-- ... å…©å€‹ button ... -->
            </div>

            <!-- âœ… æ–°å¢ï¼šæœå°‹æ¡† -->
            <div class="relative">
                <i data-lucide="search" class="w-5 h-5 absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="search-input" onkeyup="filterData()" placeholder="æœå°‹å§“åã€é›»è©±æˆ–å¯µç‰©å..."
                       class="w-full p-4 pl-12 rounded-xl border bg-white focus:ring-2 focus:ring-[#D4B5A0] outline-none text-base transition-all shadow-sm">
            </div>

            <!-- åˆ—è¡¨å®¹å™¨ -->

            <div id="content-area" class="space-y-4">
                <div class="text-center py-10 text-gray-400">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- è©³æƒ…/ç·¨è¼¯ å½ˆçª— -->
    <div id="detail-modal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-3xl w-full max-w-3xl max-h-[85vh] flex flex-col shadow-2xl transform scale-95 transition-transform duration-300" id="modal-panel">
            <div class="p-6 border-b flex justify-between items-center bg-[#FAF5F0] rounded-t-3xl">
                <h2 class="text-xl font-black text-[#5D5046]" id="modal-title">åˆç´„è©³æƒ…</h2>
                <button onclick="closeModal()" class="p-2 hover:bg-gray-200 rounded-full transition"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 overflow-y-auto no-scrollbar flex-1 space-y-6" id="modal-content"></div>
            <div class="p-6 border-t bg-white rounded-b-3xl flex justify-between items-center gap-4">
    <button onclick="requestDelete()" class="text-red-500 font-bold px-4 py-2 hover:bg-red-50 rounded-xl transition flex items-center gap-2">
        <i data-lucide="trash-2" class="w-4 h-4"></i> åˆªé™¤æ­¤å–®
    </button>
    <div class="flex gap-3">
                <div class="flex gap-3">
        <button onclick="requestEdit()" id="btn-edit" class="bg-gray-100 text-gray-600 px-6 py-2 rounded-xl font-bold hover:bg-gray-200 transition">ç·¨è¼¯</button>
        <button onclick="saveChanges()" id="btn-save" class="hidden bg-[#D4B5A0] text-white px-6 py-2 rounded-xl font-bold hover:bg-[#A89985] transition shadow-lg shadow-[#D4B5A0]/30">å„²å­˜è®Šæ›´</button>
    </div>
</div>
        </div>
    </div>

        <!-- âœ… æ–°å¢ï¼šå¯†ç¢¼ç¢ºèªå½ˆçª— -->
    <div id="password-confirm-modal" class="fixed inset-0 bg-black/60 hidden z-[60] flex items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white p-8 rounded-3xl w-full max-w-sm text-center space-y-6 shadow-xl transform scale-95 transition-transform duration-300" id="password-modal-panel">
            <h3 class="text-xl font-black text-[#5D5046]">éœ€è¦ç®¡ç†å“¡æ¬Šé™</h3>
            <p class="text-sm text-gray-500">ç‚ºç¢ºä¿å®‰å…¨ï¼Œè«‹å†æ¬¡è¼¸å…¥æ‚¨çš„ç™»å…¥å¯†ç¢¼ä»¥ç¹¼çºŒæ­¤æ“ä½œã€‚</p>
            <div class="relative">
                <i data-lucide="key-round" class="w-5 h-5 absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input type="password" id="confirm-password" placeholder="å†æ¬¡è¼¸å…¥å¯†ç¢¼" class="w-full p-4 pl-12 rounded-xl border bg-[#FAF5F0] focus:ring-2 focus:ring-red-400 outline-none text-base transition-all">
            </div>
            <div class="flex gap-3">
                <button onclick="closePasswordConfirmModal()" class="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition">å–æ¶ˆ</button>
                <button onclick="handlePasswordConfirm()" id="confirm-action-btn" class="flex-1 py-3 bg-red-500 text-white font-bold rounded-xl hover:bg-red-600 transition">ç¢ºèªæ“ä½œ</button>
            </div>
        </div>
    </div>

        <!-- âœ… æ–°å¢ï¼šåˆªé™¤ç¢ºèªå½ˆçª— -->
    <div id="delete-confirm-modal" class="fixed inset-0 bg-black/60 hidden z-[70] flex items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white p-8 rounded-3xl w-full max-w-sm text-center space-y-6 shadow-xl transform scale-95 transition-transform duration-300" id="delete-modal-panel">
            <div class="mx-auto w-16 h-16 rounded-full bg-red-100 flex items-center justify-center border-4 border-red-50">
                <i data-lucide="shield-alert" class="w-8 h-8 text-red-500"></i>
            </div>
            <div class="space-y-2">
                <h3 class="text-xl font-black text-red-800">ç¢ºèªåˆªé™¤</h3>
                <p class="text-sm text-gray-500">
                    ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿ<br>
                    <span class="font-bold">åˆªé™¤å¾Œå°‡ç„¡æ³•å¾©åŸã€‚</span>
                </p>
            </div>
            <div class="flex gap-3">
                <button onclick="closeDeleteConfirmModal()" class="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition">å–æ¶ˆ</button>
                <button onclick="proceedWithDeletion()" id="confirm-delete-btn" class="flex-1 py-3 bg-red-500 text-white font-bold rounded-xl hover:bg-red-600 transition">ç¢ºèªåˆªé™¤</button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        
        // âœ… 2. æ–°å¢ Toast é€šçŸ¥ç³»çµ±å‡½å¼
        function showToast(message, type = 'error') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const styles = {
                error: { icon: 'shield-alert', color: 'bg-red-500' },
                success: { icon: 'check-circle-2', color: 'bg-green-500' },
            };
            const style = styles[type];

            toast.className = `flex items-center gap-3 px-6 py-3 text-white font-bold rounded-full shadow-lg transform translate-y-[-50px] opacity-0 transition-all duration-300 ease-out ${style.color}`;
            toast.innerHTML = `
                <i data-lucide="${style.icon}" class="w-5 h-5"></i>
                <span>${message}</span>
            `;
            container.appendChild(toast);
            lucide.createIcons();

            setTimeout(() => {
                toast.classList.remove('translate-y-[-50px]', 'opacity-0');
            }, 10);

            setTimeout(() => {
                toast.classList.add('opacity-0', 'scale-90');
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }

        function formatTaiwanTime(isoString) {
            if (!isoString) return 'ç„¡';
            const date = new Date(isoString);
            return date.toLocaleString('zh-TW', { timeZone: 'Asia/Taipei', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
        }

        const SUPABASE_URL = 'https://gevoefsyhnboricfepay.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdldm9lZnN5aG5ib3JpY2ZlcGF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzNzEzOTMsImV4cCI6MjA4Mzk0NzM5M30.hI6PhjEycYj5njOCCZVcBwa8VX5F5g-mD3qXxGeYJLo';
        const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const FIELD_SCHEMAS = {
            sales: [ { key: 'buyer_name', label: 'è²·æ–¹å§“å' }, { key: 'buyer_phone', label: 'è²·æ–¹é›»è©±' }, { key: 'buyer_id_number', label: 'èº«åˆ†è­‰å­—è™Ÿ' }, { key: 'buyer_address', label: 'é€šè¨Šåœ°å€' }, { key: 'buyer_birthday', label: 'å‡ºç”Ÿæ—¥æœŸ' }, { key: 'pet_type', label: 'å¯µç‰©ç¨®é¡' }, { key: 'pet_sex', label: 'æ€§åˆ¥' }, { key: 'pet_breed', label: 'å¯µç‰©å“ç¨®' }, { key: 'pet_color', label: 'æ¯›è‰²' }, { key: 'pet_birthday', label: 'å¯µç‰©ç”Ÿæ—¥' }, { key: 'total_price', label: 'ç¸½åƒ¹' }, { key: 'delivery_date', label: 'äº¤ä»˜æ—¥æœŸ' }, { key: 'deposit_amount', label: 'è¨‚é‡‘' }, { key: 'balance_amount', label: 'å°¾æ¬¾' }, { key: 'payment_method', label: 'æ”¯ä»˜æ–¹å¼' }, { key: 'created_at', label: 'å»ºç«‹æ™‚é–“', readonly: true }, { key: 'signature_url', label: 'ç°½åæª”', type: 'image', readonly: true } ],
            grooming: [ { key: 'owner_name', label: 'é£¼ä¸»å§“å' }, { key: 'owner_phone', label: 'é£¼ä¸»é›»è©±' }, { key: 'owner_email', label: 'Email' }, { key: 'owner_id', label: 'èº«åˆ†è­‰å­—è™Ÿ' }, { key: 'owner_address', label: 'åœ°å€' }, { key: 'emergency_contact', label: 'ç·Šæ€¥è¯çµ¡äºº' }, { key: 'emergency_phone', label: 'ç·Šæ€¥é›»è©±' }, { key: 'pet_name', label: 'å¯µç‰©åå­—' }, { key: 'pet_breed', label: 'å“ç¨®' }, { key: 'pet_weight', label: 'é«”é‡ (kg)' }, { key: 'pet_age', label: 'å¹´é½¡' }, { key: 'pet_sex', label: 'æ€§åˆ¥' }, { key: 'pet_neuter', label: 'çµç´®ç‹€æ³' }, { key: 'pet_chip', label: 'æ™¶ç‰‡è³‡è¨Š' }, { key: 'preferred_clinic', label: 'æŒ‡å®šé†«é™¢' }, { key: 'history_notes', label: 'éå¾€ç—…å²', type: 'textarea' }, { key: 'service_type', label: 'ä¸»è¦æœå‹™' }, { key: 'total_price', label: 'ç¸½é‡‘é¡' }, { key: 'service_details', label: 'æœå‹™é …ç›®è©³æƒ…', type: 'textarea' }, { key: 'created_at', label: 'å»ºç«‹æ™‚é–“', readonly: true }, { key: 'signature_url', label: 'ç°½åæª”', type: 'image', readonly: true } ]
        };
        let currentTab = 'sales';
        let currentItem = null;
        let pendingAction = null; 


        async function checkSession() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (session) { document.getElementById('login-view').classList.add('hidden'); document.getElementById('dashboard-view').classList.remove('hidden'); loadData('sales'); }
        }
        checkSession();

        // âœ… 3. æ›´æ–°ç™»å…¥å‡½å¼ä»¥ä½¿ç”¨ Toast
        async function handleLogin() {
            const email = 'backmecat@gmail.com';
            const passwordInput = document.getElementById('password');
            const password = passwordInput.value;

            if (!password) {
                showToast('è«‹è¼¸å…¥å¯†ç¢¼', 'error');
                passwordInput.classList.add('border-red-400', 'animate-shake');
                setTimeout(() => passwordInput.classList.remove('border-red-400', 'animate-shake'), 600);
                return;
            }

            const { error } = await _supabase.auth.signInWithPassword({ email, password });
            
            if (error) {
                showToast('ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¯†ç¢¼', 'error');
                passwordInput.classList.add('border-red-400', 'animate-shake');
                setTimeout(() => passwordInput.classList.remove('border-red-400', 'animate-shake'), 600);
            }
            else {
                checkSession();
            }
        }

        document.getElementById('password').addEventListener('keydown', function(event) {
             if (event.key === 'Enter') { event.preventDefault(); handleLogin(); }
        });
        
        const style = document.createElement('style');
        style.innerHTML = `@keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } } .animate-shake { animation: shake 0.6s cubic-bezier(.36,.07,.19,.97) both; }`;
        document.head.appendChild(style);

        async function handleLogout() {
            await _supabase.auth.signOut();
            location.reload();
        }

        function switchTab(tab) {
            currentTab = tab;
            const salesBtn = document.getElementById('tab-sales');
            const groomingBtn = document.getElementById('tab-grooming');
            const activeClass = "flex-1 py-3 bg-white rounded-xl font-bold shadow-sm ring-2 ring-[#6D7DBF] text-[#6D7DBF] transition-all";
            const inactiveClass = "flex-1 py-3 bg-white/50 rounded-xl font-bold text-gray-400 hover:bg-white transition-all";
            if (tab === 'sales') {
                salesBtn.className = activeClass;
                groomingBtn.className = inactiveClass;
            } else {
                salesBtn.className = inactiveClass;
                groomingBtn.className = activeClass.replace('ring-[#6D7DBF] text-[#6D7DBF]', 'ring-[#E0899B] text-[#E0899B]');
            }
            loadData(tab);
        }

        // ... switchTab() å‡½å¼ä¹‹å¾Œ ...

        // âœ… é‡æ§‹ï¼šå°‡ loadData æ‹†åˆ†ç‚ºã€Œè®€å–ã€å’Œã€Œæ¸²æŸ“ã€
        async function loadData(type) {
            const container = document.getElementById('content-area');
            container.innerHTML = '<div class="text-center py-10"><i data-lucide="loader" class="animate-spin mx-auto text-gray-400"></i></div>';
            lucide.createIcons();
            
            // æ¸…ç©ºæœå°‹æ¡†ä¸¦é‡ç½®ç¯©é¸
            const searchInput = document.getElementById('search-input');
            if (searchInput) searchInput.value = '';

            const table = type === 'sales' ? 'sales_contracts' : 'grooming_contracts';
            
            const { data, error } = await _supabase.from(table).select('*').order('created_at', { ascending: false });

            if (error) {
                container.innerHTML = `<p class="text-red-500 text-center bg-red-50 p-4 rounded-xl">è®€å–éŒ¯èª¤ï¼š${error.message}</p>`;
                return;
            }
            
            // æš«å­˜å®Œæ•´è³‡æ–™åˆ—è¡¨
            window.fullDataList = data;
            // é¦–æ¬¡è¼‰å…¥æ™‚æ¸²æŸ“å®Œæ•´åˆ—è¡¨
            renderDataList(data);
        }

        // âœ… æ–°å¢ï¼šå°ˆé–€ç”¨ä¾†æ¸²æŸ“åˆ—è¡¨çš„å‡½å¼
        function renderDataList(data) {
            const container = document.getElementById('content-area');
            
            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 py-10">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</p>';
                return;
            }

            container.innerHTML = data.map((item, index) => {
                // æ‰¾åˆ°é€™ç­†è³‡æ–™åœ¨åŸå§‹å®Œæ•´åˆ—è¡¨ä¸­çš„ç´¢å¼•ï¼Œç¢ºä¿ openModal èƒ½æ­£ç¢ºé‹ä½œ
                const originalIndex = window.fullDataList.findIndex(fullItem => fullItem.id === item.id);
            
                const name = currentTab === 'sales' ? item.buyer_name : item.owner_name;
                const subInfo = currentTab === 'sales' ? (item.pet_breed || 'æœªçŸ¥å“ç¨®') : (item.service_type || 'æœªçŸ¥æœå‹™');
                const date = formatTaiwanTime(item.created_at);
                const badgeColor = currentTab === 'sales' ? 'bg-[#6D7DBF]/10 text-[#6D7DBF]' : 'bg-[#E0899B]/10 text-[#E0899B]';

                return `
                <div class="glass-card p-6 rounded-2xl flex flex-col md:flex-row justify-between items-start md:items-center gap-4 hover:scale-[1.01] transition-transform cursor-pointer group" onclick="openModal('${originalIndex}')">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-xs font-bold text-gray-400">${date}</span>
                            <span class="text-[10px] px-2 py-0.5 rounded-full font-bold ${badgeColor}">
                                ${currentTab === 'sales' ? 'è²·è³£' : 'ç¾å®¹'}
                            </span>
                        </div>
                        <h3 class="text-xl font-black text-[#5D5046] group-hover:text-[#D4B5A0] transition-colors">
                            ${name || '(ç„¡å§“å)'} 
                            <span class="text-sm font-normal text-gray-500 ml-1">(${subInfo})</span>
                        </h3>
                        <p class="text-sm text-gray-500 font-bold mt-1">é‡‘é¡: $${item.total_price || 0}</p>
                    </div>
                    <button class="px-4 py-2 bg-gray-100 rounded-lg text-sm font-bold text-gray-600 group-hover:bg-[#D4B5A0] group-hover:text-white transition-colors">æŸ¥çœ‹è©³æƒ…</button>
                </div>`;
            }).join('');

            window.currentDataList = window.fullDataList; // ç¶­æŒ openModal çš„è³‡æ–™æº
            lucide.createIcons();
        }

        // âœ… æ–°å¢ï¼šæœå°‹éæ¿¾å‡½å¼
        function filterData() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
            
            if (!window.fullDataList) return;

            const filteredData = window.fullDataList.filter(item => {
                if (currentTab === 'sales') {
                    const buyerName = (item.buyer_name || '').toLowerCase();
                    const buyerPhone = (item.buyer_phone || '').toLowerCase();
                    const petBreed = (item.pet_breed || '').toLowerCase();
                    return buyerName.includes(searchTerm) || buyerPhone.includes(searchTerm) || petBreed.includes(searchTerm);
                } else { // grooming
                    const ownerName = (item.owner_name || '').toLowerCase();
                    const ownerPhone = (item.owner_phone || '').toLowerCase();
                    const petName = (item.pet_name || '').toLowerCase();
                    return ownerName.includes(searchTerm) || ownerPhone.includes(searchTerm) || petName.includes(searchTerm);
                }
            });

            renderDataList(filteredData);
        }


        const modal = document.getElementById('detail-modal');
        const modalPanel = document.getElementById('modal-panel');

        function openModal(index) {
            currentItem = window.fullDataList[index]; 
            const schema = FIELD_SCHEMAS[currentTab];
            const contentDiv = document.getElementById('modal-content');
            document.getElementById('btn-edit').classList.remove('hidden');
            document.getElementById('btn-save').classList.add('hidden');
            let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
            schema.forEach(field => {
                let value = currentItem[field.key];
                if (field.key === 'created_at' && value) { value = formatTaiwanTime(value); } else { if (value === null || typeof value === 'undefined' || value === '') { value = '(æœªå¡«å¯«)'; } }
                if (field.type === 'image') { html += `<div class="col-span-1 md:col-span-2 mt-4"><label class="block text-xs font-bold text-gray-400 mb-2">${field.label}</label><div class="border-2 border-dashed border-gray-200 rounded-xl p-2 bg-gray-50"><img src="${value}" class="max-h-40 mx-auto object-contain" onerror="this.style.display='none'"></div></div>`; } else if (field.type === 'textarea') { html += `<div class="col-span-1 md:col-span-2"><label class="block text-xs font-bold text-gray-400 mb-1">${field.label}</label><textarea data-key="${field.key}" disabled class="editable-field w-full p-3 rounded-xl border bg-gray-50 text-gray-700 font-medium resize-none h-24 focus:bg-white focus:ring-2 ring-[#D4B5A0] outline-none transition-all">${value}</textarea></div>`; } else { const isReadOnly = field.readonly ? 'readonly-field' : 'editable-field'; const bgClass = field.readonly ? 'bg-gray-100/50 text-gray-400' : 'bg-gray-50 text-gray-700'; html += `<div><label class="block text-xs font-bold text-gray-400 mb-1">${field.label}</label><input type="text" data-key="${field.key}" value="${value}" disabled class="${isReadOnly} ${bgClass} w-full p-3 rounded-xl border font-medium focus:bg-white focus:ring-2 ring-[#D4B5A0] outline-none transition-all"></div>`; }
            });
            html += '</div>';
            contentDiv.innerHTML = html;
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); modalPanel.classList.remove('scale-95'); }, 10);
        }

        function closeModal() {
            modal.classList.add('opacity-0');
            modalPanel.classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

                function requestEdit() {
            pendingAction = enableEdit; // è¨­å®šå¯†ç¢¼é©—è­‰æˆåŠŸå¾Œè¦åŸ·è¡Œçš„å‹•ä½œ
            openPasswordConfirmModal();
        }
function requestDelete() {
    openDeleteConfirmModal();
}


        // çœŸæ­£çš„åŸ·è¡Œå‡½å¼
        function enableEdit() {
            document.getElementById('btn-edit').classList.add('hidden');
            document.getElementById('btn-save').classList.remove('hidden');
            document.querySelectorAll('.editable-field').forEach(input => {
                input.disabled = false;
                input.classList.remove('bg-gray-50');
                input.classList.add('bg-white', 'border-[#D4B5A0]');
                if (input.value === '(æœªå¡«å¯«)') { input.value = ''; }
            });
        }
        async function saveChanges() {
            const updates = {};
            document.querySelectorAll('.editable-field').forEach(input => {
                const key = input.getAttribute('data-key');
                updates[key] = input.value;
            });
            const table = currentTab === 'sales' ? 'sales_contracts' : 'grooming_contracts';
            const btn = document.getElementById('btn-save');
            btn.innerText = 'å„²å­˜ä¸­...';
            btn.disabled = true;
            const { error } = await _supabase.from(table).update(updates).eq('id', currentItem.id);
            
            if (error) {
                showToast('å„²å­˜å¤±æ•—ï¼š' + error.message, 'error');
                btn.innerText = 'å„²å­˜è®Šæ›´';
                btn.disabled = false;
            } else {
                showToast('å„²å­˜æˆåŠŸï¼', 'success');
                closeModal();
                loadData(currentTab);
            }
        }
        async function deleteCurrentItem() {
            const table = currentTab === 'sales' ? 'sales_contracts' : 'grooming_contracts';
            const { error } = await _supabase.from(table).delete().eq('id', currentItem.id);
            if (error) {
                showToast('åˆªé™¤å¤±æ•—ï¼š' + error.message, 'error');
            } else {
                showToast('å·²åˆªé™¤', 'success');
                closeModal();
                loadData(currentTab);
            }
        }

        function enableEdit() {
            document.getElementById('btn-edit').classList.add('hidden');
            document.getElementById('btn-save').classList.remove('hidden');
            document.querySelectorAll('.editable-field').forEach(input => {
                input.disabled = false;
                input.classList.remove('bg-gray-50');
                input.classList.add('bg-white', 'border-[#D4B5A0]');
                if (input.value === '(æœªå¡«å¯«)') { input.value = ''; }
            });
        }

        // âœ… 4. (åŠ åˆ†) å°‡å¾Œå°çš„ alert ä¹Ÿæ”¹ç‚º Toast
        async function saveChanges() {
            const updates = {};
            document.querySelectorAll('.editable-field').forEach(input => {
                const key = input.getAttribute('data-key');
                updates[key] = input.value;
            });
            const table = currentTab === 'sales' ? 'sales_contracts' : 'grooming_contracts';
            const btn = document.getElementById('btn-save');
            const originalText = btn.innerText;
            btn.innerText = 'å„²å­˜ä¸­...';
            btn.disabled = true;
            const { error } = await _supabase.from(table).update(updates).eq('id', currentItem.id);
            if (error) {
                showToast('å„²å­˜å¤±æ•—ï¼š' + error.message, 'error');
                btn.innerText = originalText;
                btn.disabled = false;
            } else {
                showToast('å„²å­˜æˆåŠŸï¼', 'success');
                closeModal();
                loadData(currentTab);
            }
        }

        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

                // âœ… æ–°å¢ï¼šå¯†ç¢¼ç¢ºèªå½ˆçª—çš„ç›¸é—œå‡½å¼
        const passwordModal = document.getElementById('password-confirm-modal');
        const passwordModalPanel = document.getElementById('password-modal-panel');
        const confirmPasswordInput = document.getElementById('confirm-password');
        function openPasswordConfirmModal() {
            passwordModal.classList.remove('hidden');
            setTimeout(() => {
                passwordModal.classList.remove('opacity-0');
                passwordModalPanel.classList.remove('scale-95');
                confirmPasswordInput.focus(); // è‡ªå‹•èšç„¦åˆ°è¼¸å…¥æ¡†
            }, 10);
        }
        function closePasswordConfirmModal() {
            passwordModal.classList.add('opacity-0');
            passwordModalPanel.classList.add('scale-95');
            setTimeout(() => {
                passwordModal.classList.add('hidden');
                confirmPasswordInput.value = ''; // æ¸…ç©ºå¯†ç¢¼
                pendingAction = null; // æ¸…é™¤å¾…è¾¦å‹•ä½œ
            }, 300);
        }
        async function handlePasswordConfirm() {
            const password = confirmPasswordInput.value;
            if (!password) {
                showToast('è«‹è¼¸å…¥å¯†ç¢¼', 'error');
                return;
            }
            
            // å†æ¬¡ä½¿ç”¨ç™»å…¥é‚è¼¯ä¾†é©—è­‰å¯†ç¢¼
            const email = 'backmecat@gmail.com';
            const { error } = await _supabase.auth.signInWithPassword({ email, password });
            if (error) {
                showToast('å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦', 'error');
                confirmPasswordInput.value = '';
                // å¢åŠ éŒ¯èª¤å‹•ç•«
                passwordModalPanel.classList.add('animate-shake');
                setTimeout(() => passwordModalPanel.classList.remove('animate-shake'), 600);
            } else {
                showToast('é©—è­‰æˆåŠŸ', 'success');
                closePasswordConfirmModal();
                // åŸ·è¡Œä¹‹å‰è¢«æ“±ç½®çš„å‹•ä½œ (ç·¨è¼¯æˆ–åˆªé™¤)
                if (pendingAction) {
                    pendingAction();
                }
            }
        }
        // è®“å¯†ç¢¼å½ˆçª—ä¹Ÿå¯ä»¥æŒ‰ Enter ç¢ºèª
        confirmPasswordInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                handlePasswordConfirm();
            }
        });
const deleteConfirmModal = document.getElementById('delete-confirm-modal');
const deleteConfirmModalPanel = document.getElementById('delete-modal-panel');
function openDeleteConfirmModal() {
    // 1. ç§»é™¤ 'hidden' è®“å…ƒç´ å¯è¦‹
    deleteConfirmModal.classList.remove('hidden');
    // 2. é€éå¾®å°çš„å»¶é²è§¸ç™¼ CSS transition å‹•ç•«
    setTimeout(() => {
        deleteConfirmModal.classList.remove('opacity-0');
        deleteConfirmModalPanel.classList.remove('scale-95');
        lucide.createIcons(); // ç¢ºä¿æ–°å½ˆçª—çš„ icon èƒ½æ¸²æŸ“
    }, 10);
}

function closeDeleteConfirmModal() {
    deleteConfirmModal.classList.add('opacity-0');
    deleteConfirmModalPanel.classList.add('scale-95');
    setTimeout(() => {
        deleteConfirmModal.classList.add('hidden');
    }, 300);
}

function proceedWithDeletion() {
    // 1. åŒæ™‚é–‹å§‹é—œé–‰å…©å€‹å½ˆçª—
    closeDeleteConfirmModal();
    closeModal(); // ğŸ‘ˆ æ–°å¢é€™è¡Œï¼
    // 2. æ¥è‘—åŸ·è¡ŒåŸä¾†çš„é‚è¼¯ï¼šè¨­å®šå¾…è¾¦äº‹é …ä¸¦æ‰“é–‹å¯†ç¢¼é©—è­‰å½ˆçª—
    pendingAction = deleteCurrentItem;
    setTimeout(() => { // å»¶é²ä¸€é»æ‰“é–‹ï¼Œé¿å…å‹•ç•«é‡ç–Š
        openPasswordConfirmModal();
    }, 300); // ç­‰å¾…é—œé–‰å‹•ç•«å®Œæˆ
}

    </script>
</body>
</html>