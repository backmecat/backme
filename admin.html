<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA é…ç½® -->
<link rel="manifest" href="/backme/manifest-admin.json">
    <link rel="icon" href="logo.jpg">
    <link rel="apple-touch-icon" href="logo.jpg">
    <link rel="apple-touch-icon" sizes="152x152" href="logo.jpg">
    <link rel="apple-touch-icon" sizes="180x180" href="logo.jpg">
    <link rel="apple-touch-icon" sizes="167x167" href="logo.jpg">
    
    <!-- PWA è®¾ç½® -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="è²å¯ç±³åŠªç®¡ç†">
    <meta name="theme-color" content="#FFF8F0">
    <meta name="robots" content="noindex, nofollow">

    <title>è²å¯ç±³åŠª | å¾Œå°ç®¡ç†ç³»çµ±</title>
    
    <!-- PWA Service Worker æ³¨å†Œ -->
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/backme/service-worker-admin.js')
                .then(reg => console.log('âœ… Admin PWA å·²å¯ç”¨:', reg.scope))
                .catch(err => console.log('âŒ Admin PWA æ³¨å†Œå¤±è´¥:', err));
        });
    }
</script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&family=Plus+Jakarta+Sans:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { 
            background-color: #FFF8F0; 
            font-family: 'Noto Serif TC', serif; 
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .safe-area-padding {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .glass-card { 
            background: rgba(255, 255, 255, 0.9); 
            border: 1px solid white; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.05); 
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .skeleton-card {
            background-color: #f3f4f6;
            border-radius: 1rem;
            padding: 1.5rem;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        .animate-shake {
            animation: shake 0.4s ease-in-out;
        }
    </style>
</head>
<body class="text-[#5D5046] antialiased min-h-screen safe-area-padding">

    <!-- Toast å®¹å™¨ -->
    <div id="toast-container" class="fixed top-5 left-0 right-0 z-[100] flex flex-col items-center space-y-2 pointer-events-none px-4 pt-[env(safe-area-inset-top)]"></div>

    <!-- ç™»å…¥ç•«é¢ -->
    <div id="login-view" class="min-h-screen flex items-center justify-center p-4 bg-[#F7F2EC]">
        <div class="bg-white p-8 rounded-3xl w-full max-w-sm text-center space-y-8 shadow-xl shadow-[#D4B5A0]/10 border border-white">
            <div class="mx-auto w-24 h-24 rounded-full bg-white p-1.5 shadow-md border-2 border-[#FFF8F0] -mt-20">
                <img src="logo.jpg" alt="Logo" class="w-full h-full object-cover rounded-full">
            </div>

            <div class="space-y-2">
                <h1 class="text-3xl font-black text-[#5D5046]">è²å¯ç±³åŠª | ç®¡ç†å¾Œå°</h1>
                <p class="text-sm text-gray-400">è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ä»¥å­˜å–è³‡æ–™</p>
            </div>

            <div class="relative">
                <i data-lucide="lock" class="w-5 h-5 absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input type="password" id="password" placeholder="è¼¸å…¥å¯†ç¢¼" 
                       class="w-full p-4 pl-12 rounded-xl border bg-[#FAF5F0] focus:ring-2 focus:ring-[#D4B5A0] outline-none text-base transition-all appearance-none">
            </div>

            <button onclick="handleLogin(event)" class="w-full py-4 bg-[#5D5046] text-white font-bold rounded-xl hover:bg-[#4a4038] transition-all active:scale-95 flex items-center justify-center gap-2 text-base shadow-lg shadow-[#5D5046]/20">
                ç™»å…¥ç³»çµ± <i data-lucide="arrow-right" class="w-5 h-5"></i>
            </button>

            <div class="pt-4 border-t border-gray-100">
                <a href="index.html" class="text-sm text-gray-400 hover:text-[#5D5046] transition-colors inline-flex items-center gap-1.5">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                    è¿”å›å¡«å¯«é¦–é 
                </a>
            </div>
        </div>
    </div>

    <!-- ä¸»æ§å°ç•«é¢ -->
    <div id="dashboard-view" class="hidden min-h-screen pb-24">
        
<!-- é ‚éƒ¨å°èˆªåˆ— -->
<nav class="bg-white/80 backdrop-blur-md p-3 sm:p-4 sticky top-0 z-40 border-b border-[#D4B5A0]/20 flex justify-between items-center pt-[calc(0.75rem+env(safe-area-inset-top))] sm:pt-[calc(1rem+env(safe-area-inset-top))]">
    <!-- Logo/æ¨™é¡Œ - æ‰‹æ©Ÿç‰ˆé¡¯ç¤ºåœ–ç‰‡ -->
    <div class="flex items-center gap-2">
        <!-- æ‰‹æ©Ÿç‰ˆ Logo åœ–ç‰‡ -->
        <div class="w-8 h-8 sm:hidden rounded-full overflow-hidden border-2 border-white shadow-sm">
            <img src="logo.jpg" alt="è²å¯ç±³åŠª Logo" class="w-full h-full object-cover">
        </div>
        <!-- æ¡Œé¢ç‰ˆæ–‡å­— -->
        <span class="hidden sm:inline font-black text-lg tracking-wide">BACKME ADMIN</span>
        <!-- æ‰‹æ©Ÿç‰ˆæ–‡å­— -->
        <span class="sm:hidden font-black text-base tracking-wide">ç®¡ç†å¾Œå°</span>
    </div>
    
    <!-- æŒ‰éˆ•ç¾¤çµ„ - æ‰‹æ©Ÿç‰ˆåªé¡¯ç¤ºåœ–ç¤º -->
    <div class="flex items-center gap-1 sm:gap-2">
        <!-- ä¿®æ”¹å¯†ç¢¼æŒ‰éˆ• -->
        <button 
            onclick="openChangePasswordModal()" 
            class="text-sm text-[#5D5046] font-bold hover:bg-[#FFF8F0] p-2.5 sm:px-3 sm:py-2 rounded-lg transition active:scale-95 flex items-center gap-1.5"
            title="ä¿®æ”¹å¯†ç¢¼"
            aria-label="ä¿®æ”¹å¯†ç¢¼">
            <i data-lucide="key" class="w-4 h-4 sm:w-4 sm:h-4"></i> 
            <span class="hidden sm:inline">ä¿®æ”¹å¯†ç¢¼</span>
        </button>
        
        <!-- ç™»å‡ºæŒ‰éˆ• -->
        <button 
            onclick="handleLogout()" 
            class="text-sm text-red-500 font-bold hover:bg-red-50 p-2.5 sm:px-3 sm:py-2 rounded-lg transition active:scale-95 flex items-center gap-1.5"
            title="ç™»å‡º"
            aria-label="ç™»å‡º">
            <i data-lucide="log-out" class="w-4 h-4 sm:w-4 sm:h-4"></i> 
            <span class="hidden sm:inline">ç™»å‡º</span>
        </button>
    </div>
</nav>

        <div class="max-w-4xl mx-auto p-4 md:p-8 space-y-6">
            
            <!-- åˆ†é åˆ‡æ› -->
            <div class="flex gap-3 sticky top-[calc(4.5rem+env(safe-area-inset-top))] z-30 bg-[#FFF8F0]/95 p-2 -mx-2 backdrop-blur-sm rounded-2xl shadow-sm border border-white/50">
                <button onclick="switchTab('sales')" id="tab-sales" class="flex-1 py-3 bg-white rounded-xl font-bold shadow-sm ring-2 ring-[#6D7DBF] text-[#6D7DBF] active:scale-95 transition-all">
                    å¯µç‰©è²·è³£
                </button>
                <button onclick="switchTab('grooming')" id="tab-grooming" class="flex-1 py-3 bg-white/50 rounded-xl font-bold text-gray-400 hover:bg-white active:scale-95 transition-all">
                    ç¾å®¹æœå‹™
                </button>
            </div>

            <!-- æœå°‹æ¡† -->
            <div class="relative group">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <i data-lucide="search" class="w-5 h-5 text-gray-400 group-focus-within:text-[#D4B5A0] transition-colors"></i>
                </div>
                <input type="search" id="search-input" placeholder="æœå°‹å§“åã€é›»è©±æˆ–å¯µç‰©å..." 
                       enterkeyhint="search"
                       class="w-full p-4 pl-12 rounded-2xl border-0 bg-white shadow-sm ring-1 ring-gray-100 focus:ring-2 focus:ring-[#D4B5A0] outline-none text-base transition-all appearance-none">
            </div>

            <!-- åˆ—è¡¨å®¹å™¨ -->
            <div id="content-area" class="space-y-4">
                <div class="text-center py-10 text-gray-400">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- âœ¨ ä¿®æ”¹å¯†ç¢¼å½ˆçª— -->
    <div id="change-password-modal" class="fixed inset-0 bg-black/60 hidden z-[60] flex items-center justify-center p-6 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white p-6 rounded-3xl w-full max-w-md text-center space-y-6 shadow-2xl transform scale-95 transition-transform duration-300" id="change-password-panel">
            <div class="flex items-center justify-between">
                <h3 class="text-xl font-black text-[#5D5046]">è®Šæ›´ç®¡ç†å¯†ç¢¼</h3>
                <button onclick="closeChangePasswordModal()" class="p-2 hover:bg-gray-100 rounded-full transition">
                    <i data-lucide="x" class="w-5 h-5 text-gray-400"></i>
                </button>
            </div>
            
            <div class="space-y-4 text-left">
                <div class="relative">
                    <i data-lucide="lock" class="w-5 h-5 absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="password" id="current-password" placeholder="è¼¸å…¥èˆŠå¯†ç¢¼" 
                           class="w-full p-3 pl-12 rounded-xl border bg-[#FAF5F0] focus:ring-2 focus:ring-[#D4B5A0] outline-none text-base transition-all">
                </div>
                
                <div class="relative">
                    <i data-lucide="key-round" class="w-5 h-5 absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="password" id="new-password" placeholder="æ–°å¯†ç¢¼ (è‡³å°‘6ä½)" 
                           class="w-full p-3 pl-12 rounded-xl border bg-[#FAF5F0] focus:ring-2 focus:ring-[#D4B5A0] outline-none text-base transition-all">
                </div>
                
                <div class="relative">
                    <i data-lucide="shield-check" class="w-5 h-5 absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="password" id="confirm-new-password" placeholder="ç¢ºèªæ–°å¯†ç¢¼" 
                           class="w-full p-3 pl-12 rounded-xl border bg-[#FAF5F0] focus:ring-2 focus:ring-[#D4B5A0] outline-none text-base transition-all">
                </div>
            </div>
            
            <div class="flex gap-3">
                <button onclick="closeChangePasswordModal()" class="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl active:scale-95 transition">
                    å–æ¶ˆ
                </button>
                <button onclick="handleChangePassword()" id="change-password-btn" class="flex-1 py-3 bg-[#5D5046] text-white font-bold rounded-xl active:scale-95 transition shadow-lg shadow-[#5D5046]/20">
                    ç¢ºèªä¿®æ”¹
                </button>
            </div>
        </div>
    </div>

    <!-- è©³æƒ…/ç·¨è¼¯å½ˆçª— -->
    <div id="detail-modal" class="fixed inset-0 bg-black/40 hidden z-50 flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-[2px] opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-3xl rounded-t-3xl sm:rounded-3xl flex flex-col shadow-2xl transform transition-transform duration-300 max-h-[92vh] sm:max-h-[85vh]" id="modal-panel">
            
            <div class="p-5 border-b flex justify-between items-center bg-[#FAF5F0] rounded-t-3xl shrink-0 sticky top-0 z-10">
                <h2 class="text-xl font-black text-[#5D5046]" id="modal-title">åˆç´„è©³æƒ…</h2>
                <button onclick="closeModal()" class="p-2 bg-white rounded-full text-gray-400 hover:bg-gray-100 active:scale-90 transition shadow-sm">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="p-6 overflow-y-auto no-scrollbar flex-1 space-y-6 pb-10" id="modal-content"></div>
            
            <div class="p-5 border-t bg-white rounded-b-none sm:rounded-b-3xl flex justify-between items-center gap-3 shrink-0 pb-[env(safe-area-inset-bottom)]">
                <button onclick="requestDelete()" class="text-red-500 font-bold px-4 py-3 hover:bg-red-50 rounded-xl transition active:scale-95 flex items-center gap-2 text-sm sm:text-base">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> <span class="hidden sm:inline">åˆªé™¤æ­¤å–®</span><span class="sm:hidden">åˆªé™¤</span>
                </button>
                <div class="flex gap-3 flex-1 justify-end">
                    <button onclick="requestEdit()" id="btn-edit" class="bg-gray-100 text-gray-600 px-6 py-3 rounded-xl font-bold hover:bg-gray-200 transition active:scale-95 flex-1 sm:flex-none">
                        ç·¨è¼¯
                    </button>
                    <button onclick="saveChanges()" id="btn-save" class="hidden bg-[#D4B5A0] text-white px-6 py-3 rounded-xl font-bold hover:bg-[#A89985] transition active:scale-95 shadow-lg shadow-[#D4B5A0]/30 flex-1 sm:flex-none">
                        å„²å­˜è®Šæ›´
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¯†ç¢¼ç¢ºèªå½ˆçª— -->
    <div id="password-confirm-modal" class="fixed inset-0 bg-black/60 hidden z-[60] flex items-center justify-center p-6 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white p-6 rounded-3xl w-full max-w-xs text-center space-y-6 shadow-2xl transform scale-95 transition-transform duration-300" id="password-modal-panel">
            <h3 class="text-lg font-black text-[#5D5046]">æ¬Šé™é©—è­‰</h3>
            <div class="relative">
                <i data-lucide="key-round" class="w-5 h-5 absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input type="password" id="confirm-password" placeholder="è¼¸å…¥å¯†ç¢¼" class="w-full p-3 pl-12 rounded-xl border bg-[#FAF5F0] focus:ring-2 focus:ring-red-400 outline-none text-base transition-all">
            </div>
            <div class="flex gap-3">
                <button onclick="closePasswordConfirmModal()" class="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl active:scale-95 transition">å–æ¶ˆ</button>
                <button onclick="handlePasswordConfirm()" id="confirm-action-btn" class="flex-1 py-3 bg-[#5D5046] text-white font-bold rounded-xl active:scale-95 transition">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <!-- åˆªé™¤ç¢ºèªå½ˆçª— -->
    <div id="delete-confirm-modal" class="fixed inset-0 bg-black/60 hidden z-[70] flex items-center justify-center p-6 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white p-6 rounded-3xl w-full max-w-xs text-center space-y-4 shadow-2xl transform scale-95 transition-transform duration-300" id="delete-modal-panel">
            <div class="mx-auto w-14 h-14 rounded-full bg-red-50 flex items-center justify-center text-red-500 mb-2">
                <i data-lucide="alert-triangle" class="w-7 h-7"></i>
            </div>
            <h3 class="text-lg font-black text-red-600">ç¢ºèªåˆªé™¤ï¼Ÿ</h3>
            <p class="text-sm text-gray-500 font-medium">æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p>
            <div class="flex gap-3 mt-4">
                <button onclick="closeDeleteConfirmModal()" class="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl active:scale-95 transition">å–æ¶ˆ</button>
                <button onclick="proceedWithDeletion()" id="confirm-delete-btn" class="flex-1 py-3 bg-red-500 text-white font-bold rounded-xl shadow-lg shadow-red-200 active:scale-95 transition">åˆªé™¤</button>
            </div>
        </div>
    </div>

<script>
lucide.createIcons();

function debounce(func, delay) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
    };
}

function showToast(message, type = 'error') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    const styles = {
        error: { icon: 'shield-alert', color: 'bg-red-500' },
        success: { icon: 'check-circle-2', color: 'bg-[#58A47E]' },
    };
    const style = styles[type] || styles.error;

    toast.className = `pointer-events-auto flex items-center gap-3 px-5 py-3 text-white text-sm font-bold rounded-full shadow-xl shadow-gray-200 transform -translate-y-4 opacity-0 transition-all duration-300 ease-out ${style.color}`;
    toast.innerHTML = `<i data-lucide="${style.icon}" class="w-4 h-4"></i><span>${message}</span>`;
    
    container.appendChild(toast);
    lucide.createIcons();

    requestAnimationFrame(() => {
        toast.classList.remove('-translate-y-4', 'opacity-0');
    });

    setTimeout(() => {
        toast.classList.add('opacity-0', '-translate-y-4');
        setTimeout(() => toast.remove(), 300);
    }, 2500);
}

function formatTaiwanTime(isoString) {
    if (!isoString) return 'ç„¡';
    const date = new Date(isoString);
    return date.toLocaleString('zh-TW', { timeZone: 'Asia/Taipei', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
}

const SUPABASE_URL = 'https://gevoefsyhnboricfepay.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdldm9lZnN5aG5ib3JpY2ZlcGF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzNzEzOTMsImV4cCI6MjA4Mzk0NzM5M30.hI6PhjEycYj5njOCCZVcBwa8VX5F5g-mD3qXxGeYJLo';
const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const FIELD_SCHEMAS = {
    sales: [
        {
            title: 'ğŸ‘¤ è²·æ–¹è³‡æ–™ (ä¹™æ–¹)',
            fields: [
                { key: 'buyer_name', label: 'å§“å', cols: 1 },
                { key: 'buyer_phone', label: 'é›»è©±', inputType: 'tel', cols: 1 },
                { key: 'buyer_id_number', label: 'èº«åˆ†è­‰å­—è™Ÿ', cols: 1 },
                { key: 'buyer_birthday', label: 'å‡ºç”Ÿæ—¥æœŸ', inputType: 'date', cols: 1 },
                { key: 'buyer_email', label: 'Email', inputType: 'email', cols: 2 },
                { key: 'buyer_address', label: 'é€šè¨Šåœ°å€', cols: 2 }
            ]
        },
        {
            title: 'ğŸ¾ å¯µç‰©è³‡è¨Š',
            fields: [
                { key: 'pet_type', label: 'ç¨®é¡', cols: 1 },
                { key: 'pet_sex', label: 'æ€§åˆ¥', cols: 1 },
                { key: 'pet_breed', label: 'å“ç¨®', cols: 1 },
                { key: 'pet_color', label: 'æ¯›è‰²', cols: 1 },
                { key: 'pet_birthday', label: 'å‡ºç”Ÿæ—¥æœŸ', inputType: 'date', cols: 1 },
                { key: 'delivery_date', label: 'äº¤ä»˜æ—¥æœŸ', inputType: 'date', cols: 1 }
            ]
        },
        {
            title: 'ğŸ’° äº¤æ˜“é‡‘é¡',
            fields: [
                { key: 'total_price', label: 'ç¸½åƒ¹', inputType: 'number', cols: 2 },
                { key: 'deposit_amount', label: 'è¨‚é‡‘', inputType: 'number', cols: 1 },
                { key: 'balance_amount', label: 'å°¾æ¬¾', inputType: 'number', cols: 1 },
                { key: 'payment_method', label: 'æ”¯ä»˜æ–¹å¼', type: 'payment', cols: 2 }
            ]
        },
        {
            title: 'ğŸ“„ å…¶ä»–è³‡è¨Š',
            fields: [
                { key: 'created_at', label: 'å»ºç«‹æ™‚é–“', readonly: true, cols: 2 },
                { key: 'signature_url', label: 'é›»å­ç°½å', type: 'image', readonly: true, cols: 2 }
            ]
        }
    ],
    grooming: [
        {
            title: 'ğŸ‘¤ é£¼ä¸»è³‡æ–™ (ç”²æ–¹)',
            fields: [
                { key: 'owner_name', label: 'å§“å', cols: 1 },
                { key: 'owner_phone', label: 'é›»è©±', inputType: 'tel', cols: 1 },
                { key: 'owner_id', label: 'èº«åˆ†è­‰å­—è™Ÿ', cols: 1 },
                { key: 'owner_email', label: 'Email', inputType: 'email', cols: 1 },
                { key: 'owner_address', label: 'åœ°å€', cols: 2 },
                { key: 'emergency_contact', label: 'ç·Šæ€¥è¯çµ¡äºº', cols: 1 },
                { key: 'emergency_phone', label: 'ç·Šæ€¥é›»è©±', inputType: 'tel', cols: 1 }
            ]
        },
        {
            title: 'ğŸ± å¯µç‰©è³‡è¨Š',
            fields: [
                { key: 'pet_name', label: 'åå­—', cols: 1 },
                { key: 'pet_breed', label: 'å“ç¨®', cols: 1 },
                { key: 'pet_sex', label: 'æ€§åˆ¥', cols: 1 },
                { key: 'pet_neuter', label: 'çµç´®', cols: 1 },
                { key: 'pet_weight', label: 'é«”é‡ (kg)', inputType: 'number', cols: 1 },
                { key: 'pet_age', label: 'å¹´é½¡', type: 'age_display', cols: 1 },
                { key: 'pet_chip', label: 'æ™¶ç‰‡è³‡è¨Š', cols: 2 },
                { key: 'preferred_clinic', label: 'æŒ‡å®šé†«é™¢', cols: 2 },
                { key: 'history_notes', label: 'éå¾€ç—…å²', type: 'textarea', cols: 2 }
            ]
        },
        {
            title: 'âœ‚ï¸ æœå‹™å…§å®¹',
            fields: [
                { key: 'service_type', label: 'ä¸»æœå‹™', cols: 2 },
                { key: 'service_details', label: 'æœå‹™ç´°é …', type: 'service_details', cols: 2 },
                { key: 'total_price', label: 'ç¸½é‡‘é¡', inputType: 'number', cols: 2 }
            ]
        },
        {
            title: 'ğŸ“„ å…¶ä»–è³‡è¨Š',
            fields: [
                { key: 'created_at', label: 'å»ºç«‹æ™‚é–“', readonly: true, cols: 2 },
                { key: 'signature_url', label: 'é›»å­ç°½å', type: 'image', readonly: true, cols: 2 }
            ]
        }
    ]
};

let currentTab = 'sales';
let currentItem = null;
let pendingAction = null;

async function checkSession() {
    const { data: { session } } = await _supabase.auth.getSession();
    if (session) { 
        document.getElementById('login-view').classList.add('hidden'); 
        document.getElementById('dashboard-view').classList.remove('hidden'); 
        loadData('sales'); 
    }
}

// ===== æ”¯ä»˜æ–¹å¼ä¸­è‹±æ–‡å°æ‡‰è¡¨ =====
const PAYMENT_METHOD_MAP = {
    'cash': 'ç¾é‡‘',
    'transfer': 'è½‰å¸³',
    'card_install': 'åˆ·å¡åˆ†æœŸ',
    'no_card_install': 'ç„¡å¡åˆ†æœŸ',
    'all_pay': 'å…¨æ”¯ä»˜'
};

/**
 * å°‡è‹±æ–‡ä»£ç¢¼è½‰æ›ç‚ºä¸­æ–‡æ¨™ç±¤
 * @param {string} methodString - ä¾‹å¦‚ "cash,transfer"
 * @returns {string} - ä¾‹å¦‚ "ç¾é‡‘, è½‰å¸³"
 */
function formatPaymentMethod(methodString) {
    if (!methodString) return '(æœªå¡«å¯«)';
    
    return methodString
        .split(',')
        .map(code => PAYMENT_METHOD_MAP[code.trim()] || code.trim())
        .join(', ');
}


checkSession();

const searchInput = document.getElementById('search-input');
searchInput.addEventListener('input', debounce(filterData, 300));

async function handleLogin(event) {
    const btn = event.currentTarget;
    const originalBtnHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i data-lucide="loader" class="animate-spin w-5 h-5"></i>';
    lucide.createIcons();

    const email = 'backmecat@gmail.com';
    const passwordInput = document.getElementById('password');
    const password = passwordInput.value;

    if (!password) {
        showToast('è«‹è¼¸å…¥å¯†ç¢¼', 'error');
        passwordInput.classList.add('ring-2', 'ring-red-400', 'animate-pulse');
        setTimeout(() => passwordInput.classList.remove('ring-2', 'ring-red-400', 'animate-pulse'), 600);
        btn.disabled = false;
        btn.innerHTML = originalBtnHTML;
        lucide.createIcons();
        return;
    }

    const { error } = await _supabase.auth.signInWithPassword({ email, password });
    
    if (error) {
        showToast('å¯†ç¢¼éŒ¯èª¤', 'error');
        btn.disabled = false;
        btn.innerHTML = originalBtnHTML;
        lucide.createIcons();
    } else {
        showToast('ç™»å…¥æˆåŠŸï¼', 'success');
        checkSession();
    }
}

document.getElementById('password').addEventListener('keydown', (e) => {
     if (e.key === 'Enter') document.querySelector('#login-view button').click(); 
});

async function handleLogout() {
    await _supabase.auth.signOut();
    location.reload();
}

function openChangePasswordModal() {
    const modal = document.getElementById('change-password-modal');
    const panel = document.getElementById('change-password-panel');
    modal.classList.remove('hidden');
    setTimeout(() => {
        modal.classList.remove('opacity-0');
        panel.classList.remove('scale-95');
        document.getElementById('current-password').focus();
    }, 10);
    lucide.createIcons();
}

function closeChangePasswordModal() {
    const modal = document.getElementById('change-password-modal');
    const panel = document.getElementById('change-password-panel');
    modal.classList.add('opacity-0');
    panel.classList.add('scale-95');
    setTimeout(() => {
        modal.classList.add('hidden');
        document.getElementById('current-password').value = '';
        document.getElementById('new-password').value = '';
        document.getElementById('confirm-new-password').value = '';
    }, 300);
}

async function handleChangePassword() {
    const btn = document.getElementById('change-password-btn');
    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i data-lucide="loader" class="animate-spin w-4 h-4"></i>';
    lucide.createIcons();

    const currentPassword = document.getElementById('current-password').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-new-password').value;

    if (!currentPassword || !newPassword || !confirmPassword) {
        showToast('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½', 'error');
        btn.disabled = false;
        btn.innerHTML = originalHTML;
        return;
    }

    if (newPassword.length < 6) {
        showToast('æ–°å¯†ç¢¼è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒ', 'error');
        btn.disabled = false;
        btn.innerHTML = originalHTML;
        return;
    }

    if (newPassword !== confirmPassword) {
        showToast('å…©æ¬¡å¯†ç¢¼è¼¸å…¥ä¸ä¸€è‡´', 'error');
        btn.disabled = false;
        btn.innerHTML = originalHTML;
        return;
    }

    const email = 'backmecat@gmail.com';
    const { error: signInError } = await _supabase.auth.signInWithPassword({ 
        email, 
        password: currentPassword 
    });

    if (signInError) {
        showToast('èˆŠå¯†ç¢¼éŒ¯èª¤', 'error');
        document.getElementById('current-password').value = '';
        document.getElementById('current-password').focus();
        btn.disabled = false;
        btn.innerHTML = originalHTML;
        return;
    }

    const { error: updateError } = await _supabase.auth.updateUser({
        password: newPassword
    });

    if (updateError) {
        showToast('å¯†ç¢¼æ›´æ–°å¤±æ•—ï¼š' + updateError.message, 'error');
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    } else {
        showToast('å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼', 'success');
        closeChangePasswordModal();
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }
}

function switchTab(tab) {
    currentTab = tab;
    const salesBtn = document.getElementById('tab-sales');
    const groomingBtn = document.getElementById('tab-grooming');
    const activeClass = "flex-1 py-3 bg-white rounded-xl font-bold shadow-sm ring-2 ring-[#6D7DBF] text-[#6D7DBF] transition-all";
    const inactiveClass = "flex-1 py-3 bg-white/50 rounded-xl font-bold text-gray-400 hover:bg-white transition-all";
    
    if (tab === 'sales') {
        salesBtn.className = activeClass;
        groomingBtn.className = inactiveClass;
    } else {
        salesBtn.className = inactiveClass;
        groomingBtn.className = activeClass.replace('ring-[#6D7DBF] text-[#6D7DBF]', 'ring-[#E0899B] text-[#E0899B]');
    }
    loadData(tab);
}

async function loadData(type) {
    const container = document.getElementById('content-area');
    let skeletonHTML = '';
    for (let i = 0; i < 5; i++) {
        skeletonHTML += `
            <div class="skeleton-card space-y-3">
                <div class="flex justify-between">
                    <div class="h-4 bg-gray-200 rounded w-1/3"></div>
                    <div class="h-4 bg-gray-200 rounded w-1/6"></div>
                </div>
                <div class="h-6 bg-gray-200 rounded w-1/2"></div>
                <div class="h-4 bg-gray-200 rounded w-full mt-2"></div>
            </div>
        `;
    }
    container.innerHTML = skeletonHTML;
    
    const searchInput = document.getElementById('search-input');
    if (searchInput) searchInput.value = '';
    
    const table = type === 'sales' ? 'sales_contracts' : 'grooming_contracts';
    const { data, error } = await _supabase.from(table).select('*').order('created_at', { ascending: false });
    
    if (error) {
        container.innerHTML = `<p class="text-red-500 text-center bg-red-50 p-4 rounded-xl">è®€å–éŒ¯èª¤ï¼š${error.message}</p>`;
        return;
    }
    window.fullDataList = data;
    renderDataList(data);
}

function renderDataList(data) {
    const container = document.getElementById('content-area');
    
    if (!data || data.length === 0) {
        container.innerHTML = `
            <div class="text-center py-16 px-4">
                <div class="bg-gray-100 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-4">
                     <i data-lucide="inbox" class="w-10 h-10 text-gray-400"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-500">æš«ç„¡è³‡æ–™</h3>
                <p class="mt-2 text-sm text-gray-400">ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç´€éŒ„</p>
            </div>
        `;
        lucide.createIcons();
        return;
    }

    container.innerHTML = data.map((item) => {
        const originalIndex = window.fullDataList.findIndex(fullItem => fullItem.id === item.id);
        const name = currentTab === 'sales' ? item.buyer_name : item.owner_name;
        const subInfo = currentTab === 'sales' ? (item.pet_breed || 'æœªçŸ¥å“ç¨®') : (item.service_type || 'æœªçŸ¥æœå‹™');
        const dateObj = new Date(item.created_at);
        const date = `${dateObj.getMonth()+1}/${dateObj.getDate()} ${String(dateObj.getHours()).padStart(2,'0')}:${String(dateObj.getMinutes()).padStart(2,'0')}`;
        
        const badgeColor = currentTab === 'sales' ? 'bg-[#6D7DBF]/10 text-[#6D7DBF]' : 'bg-[#E0899B]/10 text-[#E0899B]';

        return `
        <div class="glass-card p-5 rounded-2xl flex flex-col gap-3 active:scale-[0.98] transition-all cursor-pointer group border-l-4 ${currentTab === 'sales' ? 'border-l-[#6D7DBF]' : 'border-l-[#E0899B]'} relative" 
             onclick="openModal('${originalIndex}')">
            <div class="flex justify-between items-start">
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-[10px] px-2 py-0.5 rounded-full font-bold ${badgeColor}">
                            ${currentTab === 'sales' ? 'è²·è³£' : 'ç¾å®¹'}
                        </span>
                        <span class="text-xs font-bold text-gray-400 flex items-center gap-1">
                            <i data-lucide="clock" class="w-3 h-3"></i> ${date}
                        </span>
                    </div>
                    <h3 class="text-lg font-black text-[#5D5046]">
                        ${name || '(ç„¡å§“å)'} 
                        <span class="text-sm font-normal text-gray-500 ml-1">(${subInfo})</span>
                    </h3>
                </div>
                <div class="text-right">
                     <p class="text-base font-black text-[#5D5046]">$${item.total_price || 0}</p>
                </div>
            </div>
        </div>`;
    }).join('');
    lucide.createIcons();
}



function filterData() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
    if (!window.fullDataList) return;

    // âœ… æ–°å¢ï¼šç§»é™¤æœå°‹è©ä¸­çš„æ‰€æœ‰éæ•¸å­—å­—å…ƒï¼ˆé‡å°é›»è©±æœå°‹ï¼‰
    const cleanedSearchTerm = searchTerm.replace(/\D/g, '');

    const filteredData = window.fullDataList.filter(item => {
        if (currentTab === 'sales') {
            const buyerName = (item.buyer_name || '').toLowerCase();
            const buyerPhone = (item.buyer_phone || '').replace(/\D/g, ''); // âœ… ç§»é™¤ -
            const petBreed = (item.pet_breed || '').toLowerCase();
            
            // âœ… ä¿®æ­£ï¼šé›»è©±æ¯”å°æ™‚ä½¿ç”¨ç´”æ•¸å­—
            return buyerName.includes(searchTerm) || 
                   buyerPhone.includes(cleanedSearchTerm) || 
                   petBreed.includes(searchTerm);
        } else { 
            const ownerName = (item.owner_name || '').toLowerCase();
            const ownerPhone = (item.owner_phone || '').replace(/\D/g, ''); // âœ… ç§»é™¤ -
            const petName = (item.pet_name || '').toLowerCase();
            
            // âœ… ä¿®æ­£ï¼šé›»è©±æ¯”å°æ™‚ä½¿ç”¨ç´”æ•¸å­—
            return ownerName.includes(searchTerm) || 
                   ownerPhone.includes(cleanedSearchTerm) || 
                   petName.includes(searchTerm);
        }
    });
    renderDataList(filteredData);
}


const modal = document.getElementById('detail-modal');
const modalPanel = document.getElementById('modal-panel');

function openModal(index) {
    currentItem = window.fullDataList[index]; 
    const sections = FIELD_SCHEMAS[currentTab];
    const contentDiv = document.getElementById('modal-content');
    
    // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
    document.getElementById('btn-edit').classList.remove('hidden');
    document.getElementById('btn-save').classList.add('hidden');
    
    let html = '<div class="space-y-8">';
    
    sections.forEach(section => {
        // å€å¡Šæ¨™é¡Œ
        html += `
        <div class="bg-white/50 rounded-3xl border border-white shadow-sm overflow-hidden">
            <div class="px-6 py-3 bg-[#FAF5F0] border-b border-[#EFE6DD]">
                <h3 class="font-bold text-[#5D5046] text-base flex items-center gap-2">
                    ${section.title}
                </h3>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-5">
        `;

        section.fields.forEach(field => {
            let value = currentItem[field.key];
            if (field.key === 'created_at' && value) value = formatTaiwanTime(value);
            
            // ç‰¹æ®Šæ¬„ä½è™•ç†
            if (field.type === 'payment' && value) value = formatPaymentMethod(value);
            if (field.type === 'age_display') {
                const rawData = currentItem.raw_data || currentItem;
                if (rawData.is_under_one && rawData.age_months) value = `${rawData.age_months} å€‹æœˆ`;
                else if (rawData.age) value = `${rawData.age} æ­²`;
                else value = '';
            }
            
            if (value === null || typeof value === 'undefined') value = '';

            const colSpan = field.cols === 2 ? 'md:col-span-2' : '';
            const labelHtml = `<label class="block text-xs font-bold text-gray-400 mb-1.5 ml-1">${field.label}</label>`;

            html += `<div class="${colSpan}">`;

            // === 1. åœ–ç‰‡ (ç°½å) ===
            if (field.type === 'image') {
                html += `
                    ${labelHtml}
                    <div class="border-2 border-dashed border-gray-200 rounded-xl p-4 bg-gray-50/50 flex justify-center">
                        <img src="${value}" class="max-h-32 object-contain" onerror="this.style.display='none'">
                    </div>`;
            } 
            // === 2. æœå‹™è©³æƒ… (æ¨™ç±¤ + ç·¨è¼¯å€) ===
            else if (field.type === 'service_details') {
                const items = value.split(/[,ã€]/).map(s => s.trim()).filter(s => s);
                const tagsHtml = items.map(item => `
                    <span class="inline-flex items-center px-3 py-1 rounded-lg text-xs font-bold bg-white border border-pink-200 text-pink-600 shadow-sm whitespace-nowrap mb-2 mr-2">
                        ${item}
                    </span>
                `).join('');
                
                html += `
                    ${labelHtml}
                    <div class="view-mode-group w-full p-4 rounded-xl border border-gray-100 bg-pink-50/30 min-h-[60px]">
                        ${tagsHtml || '<span class="text-gray-400 text-xs">ç„¡å…§å®¹</span>'}
                    </div>
                    <textarea data-key="${field.key}" class="edit-mode-group editable-field hidden w-full p-3 rounded-xl border border-[#D4B5A0] bg-white text-gray-700 font-medium resize-none h-32 focus:ring-2 focus:ring-[#D4B5A0]/50 outline-none">${value}</textarea>
                `;
            }
            // === 3. é•·æ–‡å­— (ç—…å²ç­‰) ===
            else if (field.type === 'textarea') {
                html += `
                    ${labelHtml}
                    <div class="view-mode-group w-full p-3 rounded-xl border border-gray-100 bg-gray-50/50 text-gray-700 font-medium text-sm min-h-[48px]">
                        ${value || '-'}
                    </div>
                    <textarea data-key="${field.key}" class="edit-mode-group editable-field hidden w-full p-3 rounded-xl border border-[#D4B5A0] bg-white text-gray-700 font-medium resize-none h-24 focus:ring-2 focus:ring-[#D4B5A0]/50 outline-none">${value}</textarea>
                `;
            }
            // === 4. ä¸€èˆ¬æ¬„ä½ ===
            else {
                const isReadOnly = field.readonly ? 'readonly' : '';
                const bgClass = field.readonly ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-gray-50 text-gray-700';
                
                // ç‚ºäº†è®“ç·¨è¼¯é«”é©—æ›´å¥½ï¼Œæˆ‘å€‘ä½¿ç”¨ä¸€å€‹ div ä¾†é¡¯ç¤º(æª¢è¦–æ¨¡å¼)ï¼Œä¸€å€‹ input ä¾†ç·¨è¼¯(ç·¨è¼¯æ¨¡å¼)
                if (field.readonly) {
                     html += `
                        ${labelHtml}
                        <div class="w-full p-3 rounded-xl border border-gray-200 bg-gray-100 text-gray-500 font-medium text-sm">
                            ${value || '-'}
                        </div>`;
                } else {
                    html += `
                        ${labelHtml}
                        <div class="view-mode-group w-full p-3 rounded-xl border border-gray-100 bg-gray-50/50 text-gray-700 font-medium text-sm min-h-[46px] flex items-center">
                            ${value || '-'}
                        </div>
                        <input type="${field.inputType || 'text'}" data-key="${field.key}" value="${value}" 
                            class="edit-mode-group editable-field hidden w-full p-3 rounded-xl border border-[#D4B5A0] bg-white text-gray-700 font-medium focus:ring-2 focus:ring-[#D4B5A0]/50 outline-none transition-all">
                    `;
                }
            }
            html += `</div>`;
        });
        html += `</div></div>`;
    });
    
    html += '</div>';
    contentDiv.innerHTML = html;
    
    // å‹•ç•«é¡¯ç¤º
    modal.classList.remove('hidden');
    setTimeout(() => { 
        modal.classList.remove('opacity-0'); 
        modalPanel.classList.remove('translate-y-full');
        modalPanel.classList.remove('scale-95');
    }, 10);
    
    lucide.createIcons();
}

function closeModal() {
    modal.classList.add('opacity-0');
    modalPanel.classList.add('translate-y-full');
    modalPanel.classList.add('scale-95');
    setTimeout(() => { modal.classList.add('hidden'); }, 300);
}

function requestEdit() {
    pendingAction = enableEdit; 
    openPasswordConfirmModal();
}

function requestDelete() {
    openDeleteConfirmModal();
}

async function deleteCurrentItem() {
    const table = currentTab === 'sales' ? 'sales_contracts' : 'grooming_contracts';
    const { error } = await _supabase.from(table).delete().eq('id', currentItem.id);
    if (error) {
        showToast('åˆªé™¤å¤±æ•—ï¼š' + error.message, 'error');
    } else {
        showToast('å·²åˆªé™¤', 'success');
        closeModal();
        loadData(currentTab);
    }
}

function enableEdit() {
    // 1. åˆ‡æ›æŒ‰éˆ•
    document.getElementById('btn-edit').classList.add('hidden');
    document.getElementById('btn-save').classList.remove('hidden');
    
    // 2. éš±è—æª¢è¦–å…ƒä»¶
    document.querySelectorAll('.view-mode-group').forEach(el => {
        el.classList.add('hidden');
    });

    // 3. é¡¯ç¤ºä¸¦å•Ÿç”¨ç·¨è¼¯å…ƒä»¶
    document.querySelectorAll('.edit-mode-group').forEach(input => {
        input.classList.remove('hidden'); // è§£é™¤éš±è—
        input.disabled = false;
    });
    
    showToast('å·²é€²å…¥ç·¨è¼¯æ¨¡å¼', 'success');
}

async function saveChanges() {
    const updates = {};
    
    // æŠ“å–æ‰€æœ‰æœ‰ editable-field class çš„è¼¸å…¥æ¡†å€¼
    document.querySelectorAll('.editable-field').forEach(input => {
        const key = input.getAttribute('data-key');
        if (key) {
            updates[key] = input.value;
        }
    });

    const table = currentTab === 'sales' ? 'sales_contracts' : 'grooming_contracts';
    const btn = document.getElementById('btn-save');
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<i data-lucide="loader" class="animate-spin w-4 h-4"></i> å„²å­˜ä¸­';
    btn.disabled = true;
    lucide.createIcons();

    const { error } = await _supabase.from(table).update(updates).eq('id', currentItem.id);
    
    if (error) {
        showToast('å„²å­˜å¤±æ•—: ' + error.message, 'error');
        btn.innerHTML = originalText;
        btn.disabled = false;
    } else {
        showToast('å„²å­˜æˆåŠŸï¼', 'success');
        closeModal();
        loadData(currentTab); // é‡æ–°è¼‰å…¥åˆ—è¡¨ä»¥é¡¯ç¤ºæœ€æ–°è³‡æ–™
    }
}

modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
});

const passwordModal = document.getElementById('password-confirm-modal');
const passwordModalPanel = document.getElementById('password-modal-panel');
const confirmPasswordInput = document.getElementById('confirm-password');

function openPasswordConfirmModal() {
    passwordModal.classList.remove('hidden');
    setTimeout(() => {
        passwordModal.classList.remove('opacity-0');
        passwordModalPanel.classList.remove('scale-95');
        confirmPasswordInput.focus();
    }, 10);
}

function closePasswordConfirmModal() {
    const btn = document.getElementById('confirm-action-btn');
    passwordModal.classList.add('opacity-0');
    passwordModalPanel.classList.add('scale-95');
    setTimeout(() => {
        passwordModal.classList.add('hidden');
        confirmPasswordInput.value = ''; 
        pendingAction = null;
        
        btn.disabled = false;
        btn.innerHTML = 'ç¢ºèª';
        lucide.createIcons();
    }, 300);
}

async function handlePasswordConfirm() {
    const btn = document.getElementById('confirm-action-btn');
    const originalBtnHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i data-lucide="loader" class="animate-spin w-4 h-4"></i>';
    lucide.createIcons();

    const password = confirmPasswordInput.value;
    if (!password) {
        showToast('è«‹è¼¸å…¥å¯†ç¢¼', 'error');
        btn.disabled = false;
        btn.innerHTML = originalBtnHTML;
        return;
    }
    
    const email = 'backmecat@gmail.com';
    const { error } = await _supabase.auth.signInWithPassword({ email, password });
    
    if (error) {
        showToast('å¯†ç¢¼éŒ¯èª¤', 'error');
        confirmPasswordInput.value = '';
        passwordModalPanel.classList.add('animate-shake');
        setTimeout(() => passwordModalPanel.classList.remove('animate-shake'), 600);
        btn.disabled = false;
        btn.innerHTML = originalBtnHTML;
        lucide.createIcons();
    } else {
        showToast('é©—è­‰æˆåŠŸ', 'success');
        closePasswordConfirmModal();
        
        if (pendingAction) {
            await pendingAction();
            pendingAction = null;
        }
        
        btn.disabled = false;
        btn.innerHTML = originalBtnHTML;
        lucide.createIcons();
    }
}

confirmPasswordInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') handlePasswordConfirm();
});

const deleteConfirmModal = document.getElementById('delete-confirm-modal');
const deleteConfirmModalPanel = document.getElementById('delete-modal-panel');

function openDeleteConfirmModal() {
    deleteConfirmModal.classList.remove('hidden');
    setTimeout(() => {
        deleteConfirmModal.classList.remove('opacity-0');
        deleteConfirmModalPanel.classList.remove('scale-95');
    }, 10);
}

function closeDeleteConfirmModal() {
    deleteConfirmModal.classList.add('opacity-0');
    deleteConfirmModalPanel.classList.add('scale-95');
    setTimeout(() => deleteConfirmModal.classList.add('hidden'), 300);
}

function proceedWithDeletion() {
    closeDeleteConfirmModal();
    closeModal(); 
    pendingAction = deleteCurrentItem;
    setTimeout(() => openPasswordConfirmModal(), 300);
}

window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        if (!deleteConfirmModal.classList.contains('hidden')) closeDeleteConfirmModal();
        else if (!passwordModal.classList.contains('hidden')) closePasswordConfirmModal();
        else if (!modal.classList.contains('hidden')) closeModal();
        else if (!document.getElementById('change-password-modal').classList.contains('hidden')) closeChangePasswordModal();
    }
});



</script>

</body>
</html>
